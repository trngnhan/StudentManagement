{% extends "base.html" %}

{% block title %}H·ªçc k·ª≥ c·ªßa {{ school_year.school_year_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="text-center text-primary fw-bold">
    üìò C√°c h·ªçc k·ª≥ c·ªßa {{ school_year.school_year_name }}
  </h3>

  <!-- Form th√™m h·ªçc k·ª≥ -->
  <div class="card mt-3">
    <div class="card-header bg-info text-white">‚ûï Th√™m h·ªçc k·ª≥</div>
    <div class="card-body">
      <form id="addSemesterForm" class="row g-2">
        <div class="col-md-10">
          <select id="semesterType" class="form-select" required>
              <option value="1">H·ªçc k·ª≥ I</option>
              <option value="2">H·ªçc k·ª≥ II</option>
          </select>

        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-success w-100">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Danh s√°ch h·ªçc k·ª≥ -->
  <div id="semesterList" class="d-flex justify-content-center flex-wrap gap-3 mt-4">
    {% for sem in semesters %}
      <div class="card shadow-sm border-info" style="width: 20rem;" id="semester-card-{{ sem.id }}">
        <div class="card-body text-center">
          <h5 class="card-title text-info fw-bold" id="sem-title-{{ sem.id }}">üìñ {{ sem.get_semester_type_display }}</h5>
          <p class="card-text mb-0">Thu·ªôc nƒÉm h·ªçc: <strong>{{ sem.school_year.school_year_name }}</strong></p>
          <div class="d-flex justify-content-center gap-2 mt-3">
            <button onclick="editSemester({{ sem.id }}, {{ sem.semester_type }})" class="btn btn-sm btn-warning">‚úèÔ∏è S·ª≠a</button>
            <button onclick="deleteSemester({{ sem.id }})" class="btn btn-sm btn-danger">üóëÔ∏è Xo√°</button>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="col text-center text-muted">Kh√¥ng c√≥ h·ªçc k·ª≥ n√†o.</div>
    {% endfor %}
  </div>

  <div class="text-center mt-4">
    <a href="{% url 'schoolyear_manage' %}" class="btn btn-outline-secondary">‚¨ÖÔ∏è Quay l·∫°i danh s√°ch nƒÉm h·ªçc</a>
  </div>
</div>

<script>
  const yearId = {{ school_year.id }};

    document.getElementById("addSemesterForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const semesterType = parseInt(document.getElementById("semesterType").value);

      const res = await fetch("/semesters/create/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({
          semester_type: semesterType,
          school_year: yearId
        })
      });

      if (res.ok) {
        alert("ƒê√£ th√™m h·ªçc k·ª≥.");
        location.reload();
      } else {
        const data = await res.json();
        alert("L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ th√™m h·ªçc k·ª≥."));
      }
    });

    async function deleteSemester(id) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° h·ªçc k·ª≥ n√†y?")) return;

      const res = await fetch(`/semesters/${id}/delete/`, {
        method: "DELETE",
        headers: {
          "X-CSRFToken": getCookie("csrftoken")
        }
      });

      if (res.ok || res.status === 204) {
        document.getElementById(`semester-card-${id}`).remove();
        alert("ƒê√£ xo√° h·ªçc k·ª≥.");
      } else {
        const data = await res.json();
        alert("L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ xo√° h·ªçc k·ª≥."));
      }
    }

  async function editSemester(id, currentType) {
    const newType = prompt("Nh·∫≠p lo·∫°i h·ªçc k·ª≥ m·ªõi (1: HK I, 2: HK II):", currentType);
    if (newType === null || newType === "") return;

    const res = await fetch(`/semesters/${id}/update/`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ semester_type: parseInt(newType) })
    });

    if (res.ok) {
      const data = await res.json();
      document.getElementById(`sem-title-${id}`).textContent = `üìñ ${data.semester_type_display}`;
      location.reload();
      alert("ƒê√£ c·∫≠p nh·∫≠t h·ªçc k·ª≥.");
    } else {
      const data = await res.json();
      alert("L·ªói: " + (data.detail || "Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t h·ªçc k·ª≥."));
    }
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}