{% extends "base.html" %}
{% load static %}

{% block title %}Quáº£n lÃ½ NÄƒm há»c{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center text-primary fw-bold">ğŸ“† Quáº£n lÃ½ NÄƒm há»c</h2>

  <!-- ThÃ´ng bÃ¡o -->
  <div id="messageBox" class="alert d-none mt-3"></div>

  <!-- Form táº¡o nÄƒm há»c -->
  <div class="card mt-4">
    <div class="card-header bg-primary text-white">â• Táº¡o NÄƒm há»c</div>
    <div class="card-body">
      <form id="addYearForm" class="row g-2">
        <div class="col-md-10">
          <input type="text" class="form-control" id="newYearName" placeholder="VD: NÄƒm há»c 2025 - 2026" required>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-success w-100">LÆ°u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Danh sÃ¡ch nÄƒm há»c -->
  <div class="mt-5">
      <h4 class="mb-3 text-primary fw-bold">ğŸ“‹ Danh sÃ¡ch NÄƒm há»c</h4>
      <div id="schoolYearList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        <div class="col text-center text-muted" id="loadingMsg">Äang táº£i...</div>
      </div>
    </div>
</div>

<script>
  const messageBox = document.getElementById("messageBox");
  const schoolYearList = document.getElementById("schoolYearList");

  function showMessage(msg, type = "success", duration = 3000) {
    messageBox.textContent = msg;
    messageBox.className = `alert alert-${type}`;
    messageBox.classList.remove("d-none");
    setTimeout(() => messageBox.classList.add("d-none"), duration);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  async function loadSchoolYears() {
      const res = await fetch("/school-years/");
      const data = await res.json();
      const list = document.getElementById("schoolYearList");
      list.innerHTML = "";

      if (data.length === 0) {
        list.innerHTML = `<div class="col text-center text-muted">ChÆ°a cÃ³ nÄƒm há»c nÃ o.</div>`;
        return;
      }

      data.forEach(year => {
          list.innerHTML += `
            <div class="col" id="schoolyear-card-${year.id}">
              <div class="card shadow-sm h-100 border-primary">
                <div class="card-body text-center">
                  <h5 class="card-title text-primary fw-bold">
                    ğŸ“˜ ${year.school_year_name}
                  </h5>
                  <div class="mt-3 d-flex justify-content-center gap-2">
                    <a href="/schoolyear/${year.id}/semesters/" class="btn btn-sm btn-outline-info">
                      ğŸ“‚ Xem há»c ká»³
                    </a>
                    <button class="btn btn-sm btn-danger" onclick="deleteSchoolYear(${year.id})">
                      ğŸ—‘ï¸ XoÃ¡
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
    }

  loadSchoolYears();

  document.getElementById("addYearForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const name = document.getElementById("newYearName").value.trim();
      if (!name) {
        showMessage("Vui lÃ²ng nháº­p tÃªn nÄƒm há»c.", "danger");
        return;
      }

      const res = await fetch("/school-years/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ school_year_name: name })
      });

      if (res.ok) {
        showMessage("ThÃªm nÄƒm há»c thÃ nh cÃ´ng!");
        document.getElementById("newYearName").value = "";
        loadSchoolYears();
      } else {
        showMessage("KhÃ´ng thá»ƒ thÃªm nÄƒm há»c. Kiá»ƒm tra dá»¯ liá»‡u hoáº·c quyá»n truy cáº­p.", "danger");
      }
    });

  async function deleteSchoolYear(id) {
      if (!confirm("Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xoÃ¡ nÄƒm há»c nÃ y?")) return;

      try {
        const res = await fetch(`/school-years/${id}/delete/`, {
          method: "DELETE",
          headers: {
            "X-CSRFToken": getCookie("csrftoken")
          }
        });

        if (res.ok || res.status === 204) {
          const card = document.getElementById(`schoolyear-card-${id}`);
          if (card) card.remove();
          showMessage("ÄÃ£ xoÃ¡ nÄƒm há»c!");
        } else {
          const data = await res.json();
          alert("Lá»—i: " + (data.detail || "KhÃ´ng thá»ƒ xoÃ¡ nÄƒm há»c."));
        }
      } catch (error) {
        alert("Vui lÃ²ng xoÃ¡ há»c ká»³ trÆ°á»›c!!!");
      }
    }
</script>
{% endblock %}