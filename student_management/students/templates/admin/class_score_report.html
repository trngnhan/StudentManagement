{% extends "base.html" %}
{% load static %}

{% block title %}Báº£ng Ä‘iá»ƒm mÃ´n há»c{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 class="text-center mb-4 text-primary fw-bold">THá»NG KÃŠ BÃO CÃO ÄIá»‚M MÃ”N Há»ŒC</h2>

  <!-- Filter Section -->
  <div class="row mb-4">
    <div class="col-md-4">
      <label class="form-label fw-bold">MÃ´n</label>
      <select class="form-select" id="subjectFilter">
        <option selected>Chá»n mÃ´n</option>
        {% for subject in subjects %}
        <option value="{{ subject.subject_name }}">{{ subject.subject_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-bold">NÄƒm há»c</label>
      <select class="form-select" id="yearFilter">
        <option selected>Chá»n nÄƒm há»c</option>
        {% for year in school_years %}
        <option value="{{ year.school_year_name }}">{{ year.school_year_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label fw-bold">Há»c ká»³</label>
      <select class="form-select" id="semesterFilter">
        <option selected>Chá»n há»c ká»³</option>
        <option value="1">Há»c ká»³ 1</option>
        <option value="2">Há»c ká»³ 2</option>
      </select>
    </div>
  </div>

  <!-- Action Button -->
  <div class="text-center mb-4">
    <button class="btn btn-primary px-4 py-2" onclick="generateReport()">
      <i class="fas fa-chart-bar me-2"></i>XEM BÃO CÃO
    </button>
  </div>

  <!-- Report Section -->
  <div class="row">
    <div class="col-md-3">
      <div class="card shadow-sm">
        <div class="card-body">
          <h6 class="card-title">ThÃ´ng tin bÃ¡o cÃ¡o</h6>
          <div class="border p-3" style="min-height: 120px;">
            <p class="mb-1"><strong>MÃ´n há»c:</strong> <span id="selectedSubject">---</span></p>
            <p class="mb-1"><strong>NÄƒm há»c:</strong> <span id="selectedYear">---</span></p>
            <p class="mb-1"><strong>Há»c ká»³:</strong> <span id="selectedSemester">---</span></p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-9">
      <!-- Line Chart -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ğŸ“ˆ Biá»ƒu Ä‘á»“ Ä‘iá»ƒm trung bÃ¬nh theo lá»›p</h5>
        </div>
        <div class="card-body">
          <canvas id="lineChart" height="300"></canvas>
        </div>
      </div>
      
      <!-- Bar Chart -->
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">ğŸ“Š Biá»ƒu Ä‘á»“ sá»‘ lÆ°á»£ng há»c sinh theo lá»›p</h5>
        </div>
        <div class="card-body">
          <canvas id="barChart" height="350"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

{{ report_data|json_script:"report-data" }}

<!-- ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Láº¥y dá»¯ liá»‡u tá»« Django
  const reportData = JSON.parse(document.getElementById('report-data').textContent);
  
  // Debug: Hiá»ƒn thá»‹ dá»¯ liá»‡u Ä‘á»ƒ kiá»ƒm tra
  console.log('Report Data:', reportData);
  
  // Dá»¯ liá»‡u tá»« database
  const classNames = reportData.classes;
  const studentCounts = reportData.student_counts;
  const classAverages = reportData.class_averages;
  const subjectsData = reportData.subjects_data;

  // Debug: Hiá»ƒn thá»‹ tá»«ng pháº§n dá»¯ liá»‡u
  console.log('Class Names:', classNames);
  console.log('Student Counts:', studentCounts);
  console.log('Class Averages:', classAverages);
  console.log('Subjects Data:', subjectsData);

  // MÃ u sáº¯c cho tá»«ng lá»›p
  const colors = [
    'rgba(54, 162, 235, 0.8)',   // Xanh dÆ°Æ¡ng
    'rgba(255, 99, 132, 0.8)',   // Äá»
    'rgba(255, 206, 86, 0.8)',   // VÃ ng
    'rgba(75, 192, 192, 0.8)',   // Xanh lÃ¡
    'rgba(153, 102, 255, 0.8)',  // TÃ­m
    'rgba(255, 159, 64, 0.8)',   // Cam
    'rgba(255, 99, 255, 0.8)',   // Há»“ng
    'rgba(99, 255, 132, 0.8)',   // Xanh lÃ¡ nháº¡t
    'rgba(132, 99, 255, 0.8)',   // TÃ­m nháº¡t
    'rgba(255, 159, 132, 0.8)'   // Cam nháº¡t
  ];

  // Line Chart
  const lineCtx = document.getElementById('lineChart').getContext('2d');
  const lineChart = new Chart(lineCtx, {
    type: 'line',
    data: {
      labels: classNames,
      datasets: [{
        label: 'Äiá»ƒm trung bÃ¬nh',
        data: classAverages,
        borderColor: 'rgba(54, 162, 235, 1)',
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        tension: 0.4,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        title: {
          display: true,
          text: 'Biá»ƒu Ä‘á»“ Ä‘iá»ƒm trung bÃ¬nh theo lá»›p',
          font: {
            size: 16,
            weight: 'bold'
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.parsed.y.toFixed(2)} Ä‘iá»ƒm`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 10,
          ticks: {
            stepSize: 1
          },
          title: {
            display: true,
            text: 'Äiá»ƒm sá»‘'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Lá»›p há»c'
          }
        }
      }
    }
  });

  // Bar Chart
  const barCtx = document.getElementById('barChart').getContext('2d');
  const barChart = new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: classNames,
      datasets: [{
        label: 'Sá»‘ há»c sinh',
        data: studentCounts,
        backgroundColor: colors.slice(0, classNames.length),
        borderColor: colors.slice(0, classNames.length).map(c => c.replace('0.8', '1')),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        title: {
          display: true,
          text: 'Biá»ƒu Ä‘á»“ sá»‘ lÆ°á»£ng há»c sinh theo lá»›p',
          font: {
            size: 16,
            weight: 'bold'
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.parsed.y} há»c sinh`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 5
          },
          title: {
            display: true,
            text: 'Sá»‘ há»c sinh'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Lá»›p há»c'
          }
        }
      }
    }
  });

  // HÃ m xá»­ lÃ½ khi nháº¥n nÃºt "XEM BÃO CÃO"
  function generateReport() {
    const subject = document.getElementById('subjectFilter').value;
    const year = document.getElementById('yearFilter').value;
    const semester = document.getElementById('semesterFilter').value;

    // Cáº­p nháº­t thÃ´ng tin bÃ¡o cÃ¡o
    document.getElementById('selectedSubject').textContent = 
      subject === 'Chá»n mÃ´n' ? '---' : subject;
    document.getElementById('selectedYear').textContent = 
      year === 'Chá»n nÄƒm há»c' ? '---' : year;
    document.getElementById('selectedSemester').textContent = 
      semester === 'Chá»n há»c ká»³' ? '---' : `Há»c ká»³ ${semester}`;

    // Cáº­p nháº­t biá»ƒu Ä‘á»“ line chart theo mÃ´n Ä‘Æ°á»£c chá»n
    if (subject !== 'Chá»n mÃ´n' && subjectsData[subject]) {
      const subjectScores = classNames.map(className => subjectsData[subject][className] || 0);
      lineChart.data.datasets[0].data = subjectScores;
      lineChart.data.datasets[0].label = `Äiá»ƒm TB - ${subject}`;
      lineChart.update();
    } else {
      // Hiá»ƒn thá»‹ Ä‘iá»ƒm trung bÃ¬nh tá»•ng náº¿u khÃ´ng chá»n mÃ´n cá»¥ thá»ƒ
      lineChart.data.datasets[0].data = classAverages;
      lineChart.data.datasets[0].label = 'Äiá»ƒm trung bÃ¬nh tá»•ng';
      lineChart.update();
    }
  }
</script>
{% endblock %}