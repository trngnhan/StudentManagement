{% extends "base.html" %}
{% load static %}
{% block title %}Qu·∫£n l√Ω M√¥n h·ªçc{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/subject_manage.css' %}">
<link rel="stylesheet" href="{% static 'css/base_effects.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-3">
  <h2 class="text-center text-primary fw-bold">üìò Qu·∫£n l√Ω M√¥n h·ªçc</h2>
</div>

<div id="subjectMessage" class="alert d-none"></div>

<ul class="nav nav-tabs mt-4" id="mainTab" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#subject">üìö Danh s√°ch m√¥n h·ªçc</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#curriculum">üìã Ch∆∞∆°ng tr√¨nh h·ªçc</button>
  </li>
</ul>

<div class="tab-content mt-3">
  <!-- Tab 1: M√¥n h·ªçc -->
  <div class="tab-pane fade show active" id="subject">
    <div class="mb-3">
      <input type="text" id="subjectSearch" class="form-control" placeholder="üîç T√¨m m√¥n h·ªçc...">
    </div>

    <form id="addSubjectForm" class="row g-2 mb-4">
      <div class="col-md-9">
        <input type="text" id="newSubjectName" class="form-control" placeholder="Nh·∫≠p t√™n m√¥n h·ªçc" required>
      </div>
      <div class="col-md-3 text-end">
        <button type="submit" class="btn btn-success w-100">‚ûï Th√™m</button>
      </div>
    </form>

    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th style="width: 10%;">M√£</th>
          <th>T√™n m√¥n h·ªçc</th>
          <th style="width: 20%;" class="text-center">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="subjectTableBody">
        <tr><td colspan="3" class="text-center">ƒêang t·∫£i...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Tab 2: Ch∆∞∆°ng tr√¨nh h·ªçc -->
  <div class="tab-pane fade" id="curriculum">
    <h4>üß© Th√™m m√¥n h·ªçc v√†o ch∆∞∆°ng tr√¨nh</h4>
    <div id="curriculumMessage" class="alert d-none"></div>
    <form id="addCurriculumForm" class="row g-3 mt-2">
      <div class="col-md-6">
        <label for="gradeSelect" class="form-label">Ch·ªçn kh·ªëi</label>
        <select id="gradeSelect" class="form-select" required></select>
      </div>
      <div class="col-md-6">
        <label for="subjectSelect" class="form-label">Ch·ªçn m√¥n h·ªçc</label>
        <select id="subjectSelect" class="form-select" required></select>
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-success mt-2">‚ûï Th√™m v√†o ch∆∞∆°ng tr√¨nh</button>
      </div>
    </form>

    <hr class="my-4">
    <h4>üìã Danh s√°ch m√¥n h·ªçc theo kh·ªëi</h4>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Kh·ªëi</th>
          <th>M√¥n h·ªçc</th>
        </tr>
      </thead>
      <tbody id="curriculumTableBody">
        <tr><td colspan="2" class="text-center">ƒêang t·∫£i...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
</script>

<script>
  const subjectTableBody = document.getElementById("subjectTableBody");
  const curriculumTableBody = document.getElementById("curriculumTableBody");
  const gradeSelect = document.getElementById("gradeSelect");
  const subjectSelect = document.getElementById("subjectSelect");
  const messageBox = document.getElementById("subjectMessage");

    function showCurriculumMessage(text, type = "success", duration = 3000) {
      const msgBox = document.getElementById("curriculumMessage");
      msgBox.textContent = text;
      msgBox.className = `alert alert-${type}`;
      msgBox.classList.remove("d-none");

      setTimeout(() => msgBox.classList.add("d-none"), duration);
    }

  async function loadSubjects(query = "") {
      const url = query ? `/subjects/search/?q=${encodeURIComponent(query)}` : `/subjects/`;

      const accessToken = sessionStorage.getItem("access");

      const res = await fetch(url, {
        headers: {
          "Authorization": `Bearer ${accessToken}`
        }
      });

      if (!res.ok) {
        subjectTableBody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p d·ªØ li·ªáu.</td></tr>`;
        return;
      }

      const data = await res.json();
      const results = data.results || data;

      subjectTableBody.innerHTML = "";
      subjectSelect.innerHTML = "";

      if (results.length === 0) {
        subjectTableBody.innerHTML = `<tr><td colspan="3" class="text-center">Kh√¥ng c√≥ m√¥n h·ªçc.</td></tr>`;
      } else {
        results.forEach(s => {
          subjectTableBody.innerHTML += `
            <tr>
              <td>${s.id}</td>
              <td>${s.subject_name || s.name}</td>
              <td class="text-center">
                <a href="/subject_manage/edit/${s.id}/" class="btn btn-sm btn-warning">‚úèÔ∏è S·ª≠a</a>
                <button class="btn btn-sm btn-danger" onclick="deleteSubject(${s.id})">üóëÔ∏è Xo√°</button>
              </td>
            </tr>`;
          subjectSelect.innerHTML += `<option value="${s.id}">${s.subject_name || s.name}</option>`;
        });
      }
    }

  // Th√™m m√¥n h·ªçc m·ªõi
  document.getElementById("addSubjectForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const name = document.getElementById("newSubjectName").value.trim();
      const messageBox = document.getElementById("subjectMessage");

      if (!name) return;

      const res = await fetch("/subjects/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
        },
        body: JSON.stringify({ subject_name: name }),
      });

      if (res.ok) {
        document.getElementById("newSubjectName").value = "";
        loadSubjects();

        messageBox.textContent = "ƒê√£ th√™m m√¥n h·ªçc th√†nh c√¥ng!";
        messageBox.className = "alert alert-success";
        messageBox.classList.remove("d-none");
      } else {
        messageBox.textContent = "Th√™m m√¥n h·ªçc th·∫•t b·∫°i.";
        messageBox.className = "alert alert-danger";
        messageBox.classList.remove("d-none");
      }

      // T·ª± ·∫©n sau 3 gi√¢y
      setTimeout(() => messageBox.classList.add("d-none"), 3000);
});

  // Xo√° m√¥n h·ªçc
  async function deleteSubject(id) {
      if (!confirm("X√°c nh·∫≠n xo√° m√¥n h·ªçc n√†y?")) return;

      const res = await fetch(`/subjects/${id}/`, {
        method: "DELETE",
        headers: {
          "X-CSRFToken": csrftoken,
        },
      });

      if (res.ok) {
        messageBox.textContent = "üóëÔ∏è ƒê√£ xo√° m√¥n h·ªçc.";
        messageBox.className = "alert alert-success";
        messageBox.classList.remove("d-none");
        setTimeout(() => messageBox.classList.add("d-none"), 5000);
        loadSubjects();
      } else {
        messageBox.textContent = "Kh√¥ng th·ªÉ xo√° m√¥n h·ªçc.";
        messageBox.className = "alert alert-danger";
        messageBox.classList.remove("d-none");
        setTimeout(() => messageBox.classList.add("d-none"), 3000);
      }
    }

  // T·∫£i kh·ªëi l·ªõp
  async function loadGrades() {
    const res = await fetch("/grades/");
    const data = await res.json();
    gradeSelect.innerHTML = "";
    data.forEach(g => {
      gradeSelect.innerHTML += `<option value="${g.id}">${g.grade_type_display} - ${g.school_year.school_year_name}</option>`;
    });
  }

  // Th√™m v√†o ch∆∞∆°ng tr√¨nh h·ªçc
  document.getElementById("addCurriculumForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const grade_id = gradeSelect.value;
    const subject_id = subjectSelect.value;

    const res = await fetch("/curriculums/add/", {
      method: "POST",
      headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({ grade_id, subject_id }),
    });

    if (res.ok) {
      loadCurriculum();
      showCurriculumMessage("ƒê√£ th√™m v√†o ch∆∞∆°ng tr√¨nh h·ªçc th√†nh c√¥ng!");
    } else {
      const err = await res.json();
      showCurriculumMessage(err.detail || "L·ªói khi th√™m v√†o ch∆∞∆°ng tr√¨nh.", "danger");
    }
  });

  // T·∫£i danh s√°ch ch∆∞∆°ng tr√¨nh h·ªçc
  async function loadCurriculum() {
    const res = await fetch("/curriculums/");
    const data = await res.json();
    curriculumTableBody.innerHTML = "";

    if (data.length === 0) {
      curriculumTableBody.innerHTML = `<tr><td colspan="2" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
    } else {
      data.forEach(item => {
        curriculumTableBody.innerHTML += `
          <tr>
            <td>${item.grade.grade_type_display} - ${item.grade.school_year.school_year_name}</td>
            <td>${item.subject.subject_name}</td>
          </tr>`;
      });
    }
  }

  document.getElementById("subjectSearch").addEventListener("input", function () {
    const query = this.value.trim();
    loadSubjects(query);
  });

  // G·ªçi khi trang load
  loadSubjects();
  loadGrades();
  loadCurriculum();
</script>
{% endblock %}