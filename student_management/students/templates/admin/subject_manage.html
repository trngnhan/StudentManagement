{% extends "base.html" %}
{% load static %}
{% block title %}Quáº£n lÃ½ MÃ´n há»c{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/subject_manage.css' %}">
<link rel="stylesheet" href="{% static 'css/base_effects.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-3">
  <h2 class="text-center text-primary fw-bold">ğŸ“˜ Quáº£n lÃ½ MÃ´n há»c</h2>
</div>

<div id="subjectMessage" class="alert d-none"></div>

<ul class="nav nav-tabs mt-4" id="mainTab" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#subject">ğŸ“š Danh sÃ¡ch mÃ´n há»c</button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#curriculum">ğŸ“‹ ChÆ°Æ¡ng trÃ¬nh há»c</button>
  </li>
</ul>

<div class="tab-content mt-3">
  <!-- Tab 1: MÃ´n há»c -->
  <div class="tab-pane fade show active" id="subject">
    <div class="mb-3">
      <input type="text" id="subjectSearch" class="form-control" placeholder="ğŸ” TÃ¬m mÃ´n há»c...">
    </div>

    <form id="addSubjectForm" class="row g-2 mb-4">
      <div class="col-md-9">
        <input type="text" id="newSubjectName" class="form-control" placeholder="Nháº­p tÃªn mÃ´n há»c" required>
      </div>
      <div class="col-md-3 text-end">
        <button type="submit" class="btn btn-success w-100">â• ThÃªm</button>
      </div>
    </form>

    <table class="table table-bordered table-hover">
      <thead>
        <tr>
          <th style="width: 10%;">MÃ£</th>
          <th>TÃªn mÃ´n há»c</th>
          <th style="width: 20%;" class="text-center">HÃ nh Ä‘á»™ng</th>
        </tr>
      </thead>
      <tbody id="subjectTableBody">
        <tr><td colspan="3" class="text-center">Äang táº£i...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Tab 2: ChÆ°Æ¡ng trÃ¬nh há»c -->
  <div class="tab-pane fade" id="curriculum">
    <h4>ğŸ§© ThÃªm mÃ´n há»c vÃ o chÆ°Æ¡ng trÃ¬nh</h4>
    <div id="curriculumMessage" class="alert d-none"></div>
    <form id="addCurriculumForm" class="row g-3 mt-2">
      <div class="col-md-6">
        <label for="gradeSelect" class="form-label">Chá»n khá»‘i</label>
        <select id="gradeSelect" class="form-select" required></select>
      </div>
      <div class="col-md-6">
        <label for="subjectSelect" class="form-label">Chá»n mÃ´n há»c</label>
        <select id="subjectSelect" class="form-select" required></select>
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-success mt-2">â• ThÃªm vÃ o chÆ°Æ¡ng trÃ¬nh</button>
      </div>
    </form>

    <hr class="my-4">
    <h4>ğŸ“‹ Danh sÃ¡ch mÃ´n há»c theo khá»‘i</h4>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Khá»‘i</th>
          <th>MÃ´n há»c</th>
        </tr>
      </thead>
      <tbody id="curriculumTableBody">
        <tr><td colspan="2" class="text-center">Äang táº£i...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Láº¥y token tá»« server session (náº¿u chÆ°a cÃ³)
  const serverToken = "{{ request.session.access|default:'' }}";
  if (serverToken && !sessionStorage.getItem("access")) {
    sessionStorage.setItem("access", serverToken);
    console.log("âœ… Token Ä‘Ã£ Ä‘Æ°á»£c gÃ¡n vÃ o sessionStorage.");
  }

  // Láº¥y token tá»« sessionStorage
  const token = sessionStorage.getItem("access");
  if (!token) {
    alert("âš ï¸ Báº¡n chÆ°a Ä‘Äƒng nháº­p hoáº·c phiÃªn Ä‘Ã£ háº¿t háº¡n.");
    window.location.href = "/login/";
  }

  // Láº¥y CSRF token tá»« cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // Tiá»‡n Ã­ch hiá»ƒn thá»‹ thÃ´ng bÃ¡o curriculum
  function showCurriculumMessage(text, type = "success", duration = 3000) {
    const msgBox = document.getElementById("curriculumMessage");
    msgBox.textContent = text;
    msgBox.className = `alert alert-${type}`;
    msgBox.classList.remove("d-none");
    setTimeout(() => msgBox.classList.add("d-none"), duration);
  }

  const subjectTableBody = document.getElementById("subjectTableBody");
  const curriculumTableBody = document.getElementById("curriculumTableBody");
  const gradeSelect = document.getElementById("gradeSelect");
  const subjectSelect = document.getElementById("subjectSelect");
  const messageBox = document.getElementById("subjectMessage");

  // Load danh sÃ¡ch mÃ´n há»c
  async function loadSubjects(query = "") {
    const url = query ? `/subjects/search/?q=${encodeURIComponent(query)}` : `/subjects/`;
    const res = await fetch(url, {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    if (!res.ok) {
      subjectTableBody.innerHTML = `<tr><td colspan="3" class="text-danger text-center">KhÃ´ng cÃ³ quyá»n truy cáº­p dá»¯ liá»‡u.</td></tr>`;
      return;
    }

    const data = await res.json();
    const results = data.results || data;
    subjectTableBody.innerHTML = "";
    subjectSelect.innerHTML = "";

    if (results.length === 0) {
      subjectTableBody.innerHTML = `<tr><td colspan="3" class="text-center">KhÃ´ng cÃ³ mÃ´n há»c.</td></tr>`;
    } else {
      results.forEach(s => {
        subjectTableBody.innerHTML += `
          <tr>
            <td>${s.id}</td>
            <td>${s.subject_name || s.name}</td>
            <td class="text-center">
              <a href="/subject_manage/edit/${s.id}/" class="btn btn-sm btn-warning">âœï¸ Sá»­a</a>
              <button class="btn btn-sm btn-danger" onclick="deleteSubject(${s.id})">ğŸ—‘ï¸ XoÃ¡</button>
            </td>
          </tr>`;
        subjectSelect.innerHTML += `<option value="${s.id}">${s.subject_name || s.name}</option>`;
      });
    }
  }

  // ThÃªm mÃ´n há»c
  document.getElementById("addSubjectForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const name = document.getElementById("newSubjectName").value.trim();
    if (!name) return;

    const res = await fetch("/subjects/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ subject_name: name })
    });

    if (res.ok) {
      document.getElementById("newSubjectName").value = "";
      loadSubjects();
      messageBox.textContent = "âœ… ÄÃ£ thÃªm mÃ´n há»c thÃ nh cÃ´ng!";
      messageBox.className = "alert alert-success";
    } else {
      messageBox.textContent = "âŒ ThÃªm mÃ´n há»c tháº¥t báº¡i.";
      messageBox.className = "alert alert-danger";
    }
    messageBox.classList.remove("d-none");
    setTimeout(() => messageBox.classList.add("d-none"), 3000);
  });

  // XoÃ¡ mÃ´n há»c
  async function deleteSubject(id) {
    if (!confirm("XÃ¡c nháº­n xoÃ¡ mÃ´n há»c nÃ y?")) return;

    const res = await fetch(`/subjects/${id}/`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": csrftoken,
        "Authorization": `Bearer ${token}`
      }
    });

    if (res.ok) {
      messageBox.textContent = "ğŸ—‘ï¸ ÄÃ£ xoÃ¡ mÃ´n há»c.";
      messageBox.className = "alert alert-success";
      loadSubjects();
    } else {
      messageBox.textContent = "âŒ KhÃ´ng thá»ƒ xoÃ¡ mÃ´n há»c.";
      messageBox.className = "alert alert-danger";
    }
    messageBox.classList.remove("d-none");
    setTimeout(() => messageBox.classList.add("d-none"), 3000);
  }

  // Load danh sÃ¡ch khá»‘i lá»›p
  async function loadGrades() {
    const res = await fetch("/grades/", {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
    const data = await res.json();
    gradeSelect.innerHTML = "";
    data.forEach(g => {
      gradeSelect.innerHTML += `<option value="${g.id}">${g.grade_type_display} - ${g.school_year.school_year_name}</option>`;
    });
  }

  // ThÃªm vÃ o chÆ°Æ¡ng trÃ¬nh há»c
  document.getElementById("addCurriculumForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const grade_id = gradeSelect.value;
    const subject_id = subjectSelect.value;

    const res = await fetch("/curriculums/add/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ grade_id, subject_id })
    });

    if (res.ok) {
      loadCurriculum();
      showCurriculumMessage("âœ… ÄÃ£ thÃªm vÃ o chÆ°Æ¡ng trÃ¬nh há»c!");
    } else {
      const err = await res.json();
      showCurriculumMessage(err.detail || "âŒ Lá»—i khi thÃªm vÃ o chÆ°Æ¡ng trÃ¬nh.", "danger");
    }
  });

  // Load danh sÃ¡ch chÆ°Æ¡ng trÃ¬nh há»c
  async function loadCurriculum() {
    const res = await fetch("/curriculums/", {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });
    const data = await res.json();
    curriculumTableBody.innerHTML = "";

    if (data.length === 0) {
      curriculumTableBody.innerHTML = `<tr><td colspan="2" class="text-center">KhÃ´ng cÃ³ dá»¯ liá»‡u.</td></tr>`;
    } else {
      data.forEach(item => {
        curriculumTableBody.innerHTML += `
          <tr>
            <td>${item.grade.grade_type_display} - ${item.grade.school_year.school_year_name}</td>
            <td>${item.subject.subject_name}</td>
          </tr>`;
      });
    }
  }

  // Gá»i khi trang load
  document.getElementById("subjectSearch").addEventListener("input", function () {
    const query = this.value.trim();
    loadSubjects(query);
  });

  loadSubjects();
  loadGrades();
  loadCurriculum();
</script>
{% endblock %}