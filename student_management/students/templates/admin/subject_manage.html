{% extends "base.html" %}
{% load static %}
{% block title %}Qu·∫£n l√Ω M√¥n h·ªçc{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/subject_manage.css' %}">
    <link rel="stylesheet" href="{% static 'css/base_effects.css' %}">
{% endblock %}

{% block content %}
{% if messages %}
  <div>
      {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">
              {{ message }}
          </div>
      {% endfor %}
  </div>
{% endif %}

<div class="container mt-3">
    <h2 class="text-center text-primary fw-bold">üìò Qu·∫£n l√Ω M√¥n h·ªçc</h2>
</div>

<ul class="nav nav-tabs mt-4" id="mainTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="subject-tab" data-bs-toggle="tab" data-bs-target="#subject" type="button" role="tab">üìö Danh s√°ch m√¥n h·ªçc</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="curriculum-tab" data-bs-toggle="tab" data-bs-target="#curriculum" type="button" role="tab">üìã Ch∆∞∆°ng tr√¨nh h·ªçc</button>
    </li>
</ul>

<div class="tab-content mt-3" id="mainTabContent">
    <!-- Danh s√°ch m√¥n h·ªçc -->
    <div class="tab-pane fade show active" id="subject" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">üìò Danh s√°ch m√¥n h·ªçc</h3>
        </div>

    <div class="pb-md-1">
        <input type="text" id="subjectSearch" class="form-control" placeholder="üîç T√¨m m√¥n h·ªçc...">
    </div>

    <!-- Form th√™m m√¥n h·ªçc -->
    <form method="post" class="row g-2 mb-4">
        {% csrf_token %}
        <div class="col-md-9">
            <input type="text" name="subject_name" class="form-control" placeholder="Nh·∫≠p t√™n m√¥n h·ªçc" required>
        </div>
        <div class="col-md-3 text-end">
            <button type="submit" name="add_subject" class="btn btn-success w-100">‚ûï Th√™m</button>
        </div>
    </form>

    <!-- B·∫£ng m√¥n h·ªçc -->
    <table class="table table-bordered table-hover">
        <thead>
            <tr>
                <th style="width: 10%;">M√£</th>
                <th>T√™n m√¥n h·ªçc</th>
                <th style="width: 20%;" class="text-center">H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody id="subjectTableBody">  <!-- üëà th√™m id -->
            {% for subject in subjects %}
            <tr>
                <td>{{ subject.id }}</td>
                <td>{{ subject.subject_name }}</td>
                <td class="text-center">
                    <a href="{% url 'edit_subject' subject.id %}" class="btn btn-sm btn-warning">‚úèÔ∏è S·ª≠a</a>
                    <a href="{% url 'delete_subject' subject.id %}" class="btn btn-sm btn-danger"
                       onclick="return confirm('X√°c nh·∫≠n xo√° m√¥n h·ªçc n√†y?')">üóëÔ∏è Xo√°</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">Ch∆∞a c√≥ m√¥n h·ªçc n√†o.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

    <!-- Ch∆∞∆°ng tr√¨nh h·ªçc -->
    <div class="tab-pane fade" id="curriculum" role="tabpanel">
        <h3>üß© Th√™m m√¥n h·ªçc v√†o ch∆∞∆°ng tr√¨nh</h3>
{#        <div class="pb-md-1">#}
{#            <input type="text" id="subjectSearch" class="form-control" placeholder="üîç T√¨m m√¥n h·ªçc...">#}
{#        </div>#}
        <form method="post" class="row g-3 mt-2">
            {% csrf_token %}
            <div class="col-md-6">
                <label for="gradeSelect" class="form-label">Ch·ªçn kh·ªëi</label>
                <select id="gradeSelect" class="form-select" name="grade">
                    {% for grade in grades %}
                        <option value="{{ grade.id }}">{{ grade.get_grade_type_display }} - {{ grade.school_year.school_year_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="subjectSelect" class="form-label">Ch·ªçn m√¥n h·ªçc</label>
                <select id="subjectSelect" class="form-select" name="subject">
                    {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-12 text-end">
                <form method="post" class="row g-3 mt-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success mt-2">‚ûï Th√™m v√†o ch∆∞∆°ng tr√¨nh</button>
                </form>
            </div>
        </form>

        <hr class="my-4">
        <h4>üìã Danh s√°ch m√¥n h·ªçc theo kh·ªëi</h4>
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th style="width: 50%;">Kh·ªëi</th>
                    <th>M√¥n h·ªçc</th>
                </tr>
            </thead>
            <tbody>
               {% for item in curriculum %}
                <tr>
                    <td>{{ item.grade.get_grade_type_display }} - {{ item.grade.school_year.school_year_name }}</td>
                    <td>{{ item.subject.subject_name }}</td>
                </tr>
               {% empty %}
                <tr>
                    <td colspan="2" class="text-center">Ch∆∞a c√≥ m√¥n h·ªçc n√†o ƒë∆∞·ª£c ph√¢n v√†o kh·ªëi.</td>
                </tr>
               {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const searchInput = document.getElementById("subjectSearch");
    const tbody = document.getElementById("subjectTableBody");

    searchInput.addEventListener("input", function () {
      const query = this.value.trim();

      const searchUrl = query
        ? `/subject_manage/search/?q=${encodeURIComponent(query)}`
        : `/subject_manage/search/`;

      fetch(searchUrl)
        .then(response => response.json())
        .then(data => {
          tbody.innerHTML = "";

          if (data.results.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="3" class="text-center">Kh√¥ng t√¨m th·∫•y m√¥n h·ªçc n√†o.</td>
              </tr>`;
            return;
          }

          data.results.forEach(item => {
            tbody.innerHTML += `
              <tr>
                <td>${item.id}</td>
                <td>${item.name}</td>
                <td class="text-center">
                  <a href="/subject_manage/edit/${item.id}/" class="btn btn-sm btn-warning">‚úèÔ∏è S·ª≠a</a>
                  <a href="/subject_manage/delete/${item.id}/" class="btn btn-sm btn-danger" onclick="return confirm('X√°c nh·∫≠n xo√° m√¥n h·ªçc n√†y?')">üóëÔ∏è Xo√°</a>
                </td>
              </tr>`;
          });
        });
    });
</script>
{% endblock %}
